import React, { useState, useRef, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Info, X, Camera, Book, Search as SearchIcon, BookOpen, MapPin, Plus, Minus, Compass, Layers } from 'lucide-react';
import mapaImg1 from './assets/images/1.jpg';
import mapaImg2 from './assets/images/2.jpg';
// Fondo con color sólido en lugar de textura
import { CategoryIcon } from './CategoryIcon';
import { AudioPlayer } from './components/AudioPlayer';
import { useAudioPlayer } from './hooks/useAudioPlayer';

// Theme based on the Bojayá map image - refined color palette
const theme = {
  colors: {
    primary: '#426D5A',         // Forest green from the map
    secondary: '#A0C6E1',       // Light blue from rivers/water
    accent: '#E9A668',          // Orange/ochre from points on the map
    dark: '#1F3A2D',            // Very dark green for contrast
    light: '#F3F7F4',           // Light green-white for backgrounds
    textDark: '#2A3B35',        // Dark text
    textLight: '#F8F9FA',       // Light text
    highlight: '#D35FB3',       // Accent color for interactive elements
    warning: '#E45F5F',         // Warning/alert color
    riverBlue: '#7CBBCD',       // River blue from the map
    mapGreen: '#6B8F78',        // Main map green
    mapBackground: '#3D5447',   // Darker green background
    caribbeanSea: '#A0C6E1',    // Caribbean sea blue
    pacificOcean: '#90B4D0',    // Pacific ocean blue
    borderLight: 'rgba(255, 255, 255, 0.2)', // Light border
    borderDark: 'rgba(0, 0, 0, 0.2)',       // Dark border
    
    // Category colors directly from the map
    memoriaColor: '#D35FB3',    // Pink/purple for "El lugar de memoria"
    conmemorativoColor: '#D35FB3', // Pink/purple for "Conmemorativo"
    ritualesColor: '#70D684',   // Green for "Rituales Mortuorios"
    encuentrosColor: '#E4A05F',  // Orange for "Espacios de encuentro"
    fortalecimientoColor: '#5FB3D3', // Blue for "Fortalecimiento"
    promocionColor: '#E9A668',  // Orange/ochre for "Promoción"
    museologiaColor: '#A0C4B9', // Teal for "Museología Territorial"
    articulacionColor: '#5FE4B3', // Turquoise for "Articulación"
    archivoColor: '#5F87E4',    // Blue for "Archivo y memoria"
  },
  fonts: {
    primary: '"Montserrat", -apple-system, BlinkMacSystemFont, sans-serif',
    secondary: '"Georgia", serif',
  },
  gradients: {
    darkOverlay: 'linear-gradient(to bottom, rgba(31, 58, 45, 0.9), rgba(31, 58, 45, 0.7))',
    lightOverlay: 'linear-gradient(to bottom, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7))',
    accentGradient: 'linear-gradient(135deg, #E9A668, #D35FB3)',
    mapBackground: 'linear-gradient(to bottom, #3D5447, #1F3A2D)',
    buttonGradient: 'linear-gradient(to bottom, rgba(75, 85, 99, 0.7), rgba(31, 41, 55, 0.9))',
  },
  shadows: {
    sm: '0 1px 2px rgba(0, 0, 0, 0.05)',
    md: '0 4px 6px rgba(0, 0, 0, 0.1)',
    lg: '0 10px 15px rgba(0, 0, 0, 0.1)',
    xl: '0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04)',
    inner: 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
    glow: '0 0 15px rgba(233, 166, 104, 0.3)',
  }
};

// Categories exactly matching the map legend
const categories = [
  { 
    id: 'all', 
    name: 'Todos los puntos', 
    color: theme.colors.primary,
    icon: 'all',
    description: 'Visualizar todos los puntos de interés'
  },
  { 
    id: 'memoria', 
    name: 'El lugar de memoria: El río Atrato', 
    color: theme.colors.memoriaColor,
    icon: 'memoria',
    description: 'Cartografía participativa'
  },
  { 
    id: 'conmemorativo', 
    name: 'Conmemorativo', 
    color: theme.colors.conmemorativoColor,
    icon: 'conmemorativo',
    description: 'Alabaos, Gualíes y Novenarios del 02 de Mayo'
  },
  { 
    id: 'rituales', 
    name: 'Rituales Mortuorios', 
    color: theme.colors.ritualesColor,
    icon: 'rituales',
    description: 'Patrimonio inmaterial de la nación'
  },
  { 
    id: 'encuentros', 
    name: 'Espacios de encuentro', 
    color: theme.colors.encuentrosColor,
    icon: 'encuentros',
    description: 'Apoyo a organizaciones de procesos'
  },
  { 
    id: 'fortalecimiento', 
    name: 'Fortalecimiento de experiencias', 
    color: theme.colors.fortalecimientoColor,
    icon: 'fortalecimiento',
    description: 'Transferencia de experiencias a través de documentación y capacitación'
  },
  { 
    id: 'promocion', 
    name: 'Promoción y fortalecimiento', 
    color: theme.colors.promocionColor,
    icon: 'promocion',
    description: 'De la vida y dignidad de las personas'
  },
  { 
    id: 'museologia', 
    name: 'Museología Territorial', 
    color: theme.colors.museologiaColor,
    icon: 'museologia',
    description: 'Promoción y realización de procesos de investigación con comunidades indígenas'
  },
  { 
    id: 'articulacion', 
    name: 'Articulación Interinstitucional', 
    color: theme.colors.articulacionColor,
    icon: 'articulacion',
    description: 'Promoción de espacios de diálogo'
  },
  { 
    id: 'archivo', 
    name: 'Archivo y memoria histórica', 
    color: theme.colors.archivoColor,
    icon: 'archivo',
    description: 'Registro de la región'
  }
];

const MapExplorer = () => {
  // States for the interface
  const [isLoading, setIsLoading] = useState(true);
  const [showLeftPanel, setShowLeftPanel] = useState(true);
  const [activeHotspot, setActiveHotspot] = useState(null);
  const [showMagnifier, setShowMagnifier] = useState(false);
  const [showLegend, setShowLegend] = useState(false);
  const [showBibliography, setShowBibliography] = useState(false);
  const [currentMapIndex, setCurrentMapIndex] = useState(0);
  const [zoomLevel, setZoomLevel] = useState(1.5); // Starting with more zoom
  const [panPosition, setPanPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [activeCategory, setActiveCategory] = useState(null);
  const [mapSize, setMapSize] = useState({ width: 0, height: 0 });
  
  // Available maps
  const maps = [
    { id: 1, img: mapaImg1, name: "Plan Vivo de Memoria y Paisaje", imgHD: mapaImg1 }, // Aquí deberías cambiar mapaImg1 por tu imagen HD cuando la tengas disponible
    { id: 2, img: mapaImg2, name: "Mapa Detallado", imgHD: mapaImg2 }
  ];
  
  // Available audios
  const audios = [
    {
      id: 1,
      title: "Memorias del Bojayá",
      artist: "Comunidad de Bojayá",
      path: import.meta.env.DEV 
        ? "/src/assets/audio/BALDOLOINO_ESCALA-CARIBE-PACIFICO.mp3" 
        : "/assets/audio/BALDOLOINO_ESCALA-CARIBE-PACIFICO.mp3"
    },
    {
      id: 2,
      title: "Voces del Atrato",
      artist: "Cantadores tradicionales",
      path: import.meta.env.DEV 
        ? "/src/assets/audio/PATRICK-MORALES_ESCALA-CARIBE-PACÍFICO.mp3"
        : "/assets/audio/PATRICK-MORALES_ESCALA-CARIBE-PACÍFICO.mp3"
    },
    {
      id: 3,
      title: "Alabaos: Cantos de memoria",
      artist: "Cantadoras de Bojayá",
      path: import.meta.env.DEV 
        ? "/src/assets/audio/BALDOLOINO_ESCALA-CARIBE-PACIFICO.mp3" 
        : "/assets/audio/BALDOLOINO_ESCALA-CARIBE-PACIFICO.mp3"
    }
  ];
  
  // Inicializar el reproductor de audio
  const audioPlayer = useAudioPlayer(audios, audios[0]);
  
  // References
  const mapRef = useRef(null);
  const containerRef = useRef(null);
  const [[imgWidth, imgHeight], setSize] = useState([0, 0]);
  const [[x, y], setXY] = useState([0, 0]);
  
  // Magnifier configuration
  const magnifierSize = 150;
  const magnification = 2;
  
  // Hotspots based on the map locations - coordenadas ajustadas para imagen 1240 x 1772
  const hotspots = [
    {
      id: 1,
      category: 'memoria',
      name: 'Río Atrato',
      description: 'El río Atrato es la arteria principal dentro del territorio. Genera conexión sur-norte desde Quibdó. Es el lugar de memoria vital para las comunidades de la región.',
      position: { x: 48, y: 50 }, // Ajustado para nueva imagen
      details: [
        { title: 'Importancia Cultural', content: 'Arteria principal del territorio y vía de comunicación ancestral para las comunidades.' },
        { title: 'Características', content: 'Uno de los ríos más caudalosos del mundo en relación con su cuenca.' },
        { title: 'Cartografía Participativa', content: 'El río es un elemento central en la cartografía participativa de las comunidades locales.' }
      ]
    },
    // ... [resto de hotspots no mostrados aquí para ahorrar espacio]
  ];

  // Filter hotspots by active category
  const filteredHotspots = activeCategory 
    ? hotspots.filter(spot => spot.category === activeCategory)
    : hotspots;

  // Function to select a category and handle related actions
  const selectCategory = (categoryId) => {
    setActiveCategory(categoryId === 'all' ? null : categoryId);
    
    // If selecting a category, find the first point of that category
    if (categoryId && categoryId !== 'all') {
      const firstPoint = hotspots.find(spot => spot.category === categoryId);
      if (firstPoint) {
        // Set the hotspot active and zoom to it
        setActiveHotspot(firstPoint.id);
        zoomToPoint(firstPoint.position.x, firstPoint.position.y, 1.8);
      }
    } else {
      // If deselecting or selecting "all", close the active popup
      setActiveHotspot(null);
      setZoomLevel(1.5);
      zoomToPoint(40, 65, 1.5);
    }
  };

  // Initialize with zoomed in view and centered
  useEffect(() => {
    if (containerRef.current && mapRef.current) {
      const containerWidth = containerRef.current.clientWidth;
      const containerHeight = containerRef.current.clientHeight;
      
      // Center point - Bojayá area
      const focusPoint = { x: 40, y: 65 };
      
      // Calculate image real size when loaded
      const img = new Image();
      img.onload = () => {
        setMapSize({
          width: img.width,
          height: img.height
        });
        
        // Ajustar para que la imagen esté alineada correctamente cuando el menú está abierto
        const menuWidth = 400; // Ancho del panel lateral
        let initialX = 0;

        if (showLeftPanel) {
          // Si el panel está abierto, ajusta la posición para compensar
          initialX = menuWidth / 2;
        }
        
        // Set initial position with adjusted X and centered vertical position
        // Ajustamos el zoom inicial para que sea más cómodo navegar
        setPanPosition({ x: initialX, y: -200 }); // Movemos un poco hacia abajo para ver mejor la parte superior
        setZoomLevel(1.0); // Zoom más alejado para mejor navegación
      };
      img.src = maps[currentMapIndex].imgHD || maps[currentMapIndex].img;
    }
    
    // Set loading time
    const timer = setTimeout(() => {
      setIsLoading(false);
    }, 1500);
    return () => clearTimeout(timer);
  }, [showLeftPanel]); // Añadir showLeftPanel como dependencia

  // Ajustar posición horizontal cuando el panel lateral cambia
  useEffect(() => {
    if (containerRef.current && mapRef.current) {
      const menuWidth = 400; // Ancho del panel lateral
      let adjustedX = panPosition.x;
      
      if (showLeftPanel) {
        // Cuando el menú se abre, mueve la imagen a la derecha
        adjustedX = menuWidth / 2;
      } else {
        // Cuando el menú se cierra, centra la imagen
        adjustedX = 0;
      }
      
      setPanPosition(prev => ({ x: adjustedX, y: prev.y }));
    }
  }, [showLeftPanel]);

  // Zoom and navigation handlers
  const handleZoomIn = () => {
    setZoomLevel(prev => Math.min(prev + 0.2, 4));
  };

  const handleZoomOut = () => {
    setZoomLevel(prev => Math.max(prev - 0.2, 0.5));
  };
  
  // Function to zoom to a specific point
  const zoomToPoint = (x, y, level = 2) => {
    if (containerRef.current && mapRef.current) {
      const containerRect = containerRef.current.getBoundingClientRect();
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      
      // Calculate the center position of the container
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      
      // Calculate coordinates of the point in relation to the image
      const pointX = (x / 100) * mapRef.current.offsetWidth;
      const pointY = (y / 100) * mapRef.current.offsetHeight;
      
      // Calculate the displacement needed to center the point
      const newPanX = centerX - (pointX * level);
      // Restrict horizontal movement (optional, remove if you want full horizontal freedom)
      // const newPanY = centerY - (pointY * level);
      
      // Only allow vertical panning
      const newPanY = Math.min(centerY - (pointY * level), 0);
      
      // Animate the zoom and displacement
      setZoomLevel(level);
      
      // Smoothly animate the movement to the point
      setPanPosition({ x: newPanX, y: newPanY });
    }
  };

  const handleMouseDown = (e) => {
    if (e.button === 0) { // Only with left button
      setIsDragging(true);
      setDragStart({
        x: e.clientX - panPosition.x,
        y: e.clientY - panPosition.y
      });
    }
  };

  const handleMouseMove = (e) => {
    if (isDragging && containerRef.current && mapRef.current) {
      const containerRect = containerRef.current.getBoundingClientRect();
      const mapRect = mapRef.current.getBoundingClientRect();
      
      // Calculate movement limits
      const maxX = containerRect.width;
      const minX = containerRect.width - (mapRect.width * zoomLevel);
      const maxY = containerRect.height;
      const minY = containerRect.height - (mapRect.height * zoomLevel);
      
      // New coordinates
      const newX = e.clientX - dragStart.x;
      const newY = e.clientY - dragStart.y;
      
      // Mantener posición X fija (bloqueo horizontal)
      // Para imágenes de alta resolución, usamos posición horizontal centralizada
      const menuWidth = 400; // Ancho del panel lateral
      const fixedX = showLeftPanel ? menuWidth / 2 : 0; // Ajustar si el panel está abierto
      
      // Aplicar solo movimiento vertical
      // Damos más margen para desplazamiento vertical por la altura de la imagen
      const verticalPadding = 400; // Mayor margen para la imagen alta
      setPanPosition({ 
        x: fixedX, // Posición horizontal fija
        y: Math.min(Math.max(newY, minY - verticalPadding), verticalPadding) // Solo movimiento vertical
      });
    }

    // Update position for the magnifier
    if (showMagnifier && mapRef.current) {
      const rect = mapRef.current.getBoundingClientRect();
      const newX = e.clientX - rect.left;
      const newY = e.clientY - rect.top;
      setXY([newX, newY]);
      setSize([rect.width, rect.height]);
    }
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  // Handler for mouseenter (magnifier)
  const handleMouseEnter = () => {
    if (showMagnifier && mapRef.current) {
      const { width, height } = mapRef.current.getBoundingClientRect();
      setSize([width, height]);
    }
  };

  return (
    <div className="map-container" style={{ 
      fontFamily: theme.fonts.primary,
      width: '100%',
      height: '100vh',
      overflow: 'hidden',
      position: 'relative',
      color: 'white',
      backgroundColor: theme.colors.mapBackground,
      backgroundImage: theme.gradients.mapBackground
    }}>
      {/* Main map container */}
      <div 
        ref={containerRef}
        style={{
          width: '100%',
          height: `calc(100vh - ${audioPlayer.isAudioPlayerExpanded ? '300px' : '100px'})`,
          position: 'relative',
          overflow: 'hidden',
          transition: 'height 0.5s ease'
        }}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onMouseEnter={handleMouseEnter}
      >
        {/* Map with zoom and pan */}
        <div 
          className="zoom-transition"
          style={{ 
            position: 'absolute',
            transform: `translate(${panPosition.x}px, ${panPosition.y}px) scale(${zoomLevel})`,
            transformOrigin: 'center',
            cursor: isDragging ? 'grabbing' : 'grab',
            userSelect: 'none',
            WebkitUserSelect: 'none',
            MozUserSelect: 'none',
            transition: 'transform 0.5s cubic-bezier(0.22, 1, 0.36, 1)'
          }}
        >
          <img
            ref={mapRef}
            src={maps[currentMapIndex].imgHD || maps[currentMapIndex].img} /* Usar imagen HD si está disponible */
            alt={`${maps[currentMapIndex].name} - Plan Vivo de Memoria y Paisaje de Bojayá`}
            style={{ 
              minWidth: '800px', 
              minHeight: '600px',
              maxWidth: 'none',
              transition: 'opacity 0.7s ease',
              opacity: isLoading ? 0 : 1,
              userDrag: 'none',
              WebkitUserDrag: 'none'
            }}
          />
          
          {/* Puntos de interés (hotspots) */}
          {filteredHotspots.map(spot => (
            <button
              key={spot.id}
              onClick={() => setActiveHotspot(activeHotspot === spot.id ? null : spot.id)}
              style={{
                position: 'absolute',
                left: `${spot.position.x}%`,
                top: `${spot.position.y}%`,
                transform: 'translate(-50%, -50%)',
                width: '28px',
                height: '28px',
                borderRadius: '50%',
                backgroundColor: categories.find(c => c.id === spot.category)?.color || theme.colors.accent,
                border: `2px solid rgba(255, 255, 255, ${activeHotspot === spot.id ? '1' : '0.9'})`,
                boxShadow: activeHotspot === spot.id ? theme.shadows.glow : theme.shadows.md,
                cursor: 'pointer',
                zIndex: 20,
                transition: 'all 300ms ease',
                scale: activeHotspot === spot.id ? '1.2' : '1',
                opacity: showLeftPanel ? 1 : 0.8
              }}
              title={spot.name}
            >
              <CategoryIcon 
                category={spot.category} 
                color="white" 
                size={14} 
              />
            </button>
          ))}
        </div>
        
        {/* Magnifier lens */}
        {showMagnifier && (
          <div
            style={{
              position: 'absolute',
              left: Math.max(0, Math.min(x - magnifierSize / 2, imgWidth - magnifierSize)),
              top: Math.max(0, Math.min(y - magnifierSize / 2, imgHeight - magnifierSize)),
              width: `${magnifierSize}px`,
              height: `${magnifierSize}px`,
              border: '2px solid white',
              borderRadius: '50%',
              pointerEvents: 'none',
              cursor: 'none',
              backgroundImage: `url(${maps[currentMapIndex].imgHD || maps[currentMapIndex].img})`,
              backgroundRepeat: 'no-repeat',
              backgroundSize: `${imgWidth * magnification}px ${imgHeight * magnification}px`,
              backgroundPosition: `${-x * magnification + magnifierSize / 2}px ${-y * magnification + magnifierSize / 2}px`,
              boxShadow: theme.shadows.lg,
              zIndex: 40
            }}
          />
        )}
        
        {/* Hotspot popup */}
        {activeHotspot && (
          <div style={{
            position: 'fixed', // Changed from absolute to fixed for better positioning
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            zIndex: 30,
            width: '450px',
            maxWidth: '95vw',
            maxHeight: '80vh',
            overflowY: 'auto',
            background: 'rgba(255, 255, 255, 0.95)',
            backdropFilter: 'blur(16px)',
            borderRadius: '16px',
            boxShadow: theme.shadows.xl,
            overflow: 'hidden',
            transition: 'all 300ms ease',
            animation: 'fadeIn 0.5s ease-out',
            fontFamily: theme.fonts.primary
          }}>
            <div style={{ 
              borderLeft: `5px solid ${categories.find(c => c.id === hotspots.find(h => h.id === activeHotspot)?.category)?.color || theme.colors.accent}`,
              padding: '28px 24px'
            }}>
              <div style={{ position: 'relative' }}>
                {/* Category tag */}
                <div style={{
                  position: 'absolute',
                  top: '-48px',
                  left: '-28px',
                  backgroundColor: categories.find(c => c.id === hotspots.find(h => h.id === activeHotspot)?.category)?.color || theme.colors.accent,
                  color: '#111827',
                  padding: '8px 16px',
                  borderRadius: '0 9999px 9999px 0',
                  fontSize: '12px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  {/* Add category icon */}
                  <CategoryIcon 
                    category={hotspots.find(h => h.id === activeHotspot)?.category} 
                    color="#111827" 
                    size={14} 
                  />
                  {categories.find(c => c.id === hotspots.find(h => h.id === activeHotspot)?.category)?.name || 'General'}
                </div>
                
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                  <h2 style={{ 
                    color: '#111827', 
                    margin: 0, 
                    fontSize: '24px', 
                    fontWeight: '700',
                    flex: '1'
                  }}>
                    {hotspots.find(h => h.id === activeHotspot)?.name}
                  </h2>
                  <button 
                    onClick={() => setActiveHotspot(null)}
                    style={{
                      background: 'transparent',
                      border: 'none',
                      padding: '4px',
                      cursor: 'pointer',
                      color: '#6B7280',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      borderRadius: '50%',
                      width: '32px',
                      height: '32px',
                      marginTop: '-8px',
                      marginRight: '-8px',
                      transition: 'background-color 200ms ease'
                    }}
                  >
                    <X size={20} />
                  </button>
                </div>
                
                <p style={{ 
                  color: '#4B5563', 
                  marginTop: '12px', 
                  marginBottom: '20px', 
                  lineHeight: '1.6',
                  fontSize: '15px' 
                }}>
                  {hotspots.find(h => h.id === activeHotspot)?.description}
                </p>
                
                {/* Details section */}
                <div style={{ 
                  marginTop: '24px',
                  borderTop: '1px solid #E5E7EB',
                  paddingTop: '20px'
                }}>
                  <h3 style={{ 
                    color: '#111827', 
                    fontSize: '16px', 
                    fontWeight: '600',
                    marginTop: 0,
                    marginBottom: '16px' 
                  }}>
                    Detalles
                  </h3>
                  
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {hotspots.find(h => h.id === activeHotspot)?.details.map((detail, index) => (
                      <div key={index} style={{ marginBottom: '4px' }}>
                        <h4 style={{ 
                          color: '#111827', 
                          margin: '0 0 4px 0', 
                          fontSize: '14px', 
                          fontWeight: '600' 
                        }}>
                          {detail.title}
                        </h4>
                        <p style={{ 
                          color: '#4B5563', 
                          margin: 0, 
                          fontSize: '14px',
                          lineHeight: '1.5'
                        }}>
                          {detail.content}
                        </p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* Left panel */}
        <div 
          style={{
            position: 'absolute',
            left: showLeftPanel ? 0 : '-400px',
            top: 0,
            bottom: 0,
            width: '400px', // Fixed width for the panel
            backgroundColor: 'rgba(17, 24, 39, 0.9)',
            backdropFilter: 'blur(4px)',
            zIndex: 20,
            transition: 'left 0.5s cubic-bezier(0.22, 1, 0.36, 1)',
            padding: '24px',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '10px 0 30px rgba(0, 0, 0, 0.1)',
            borderRight: '1px solid rgba(255, 255, 255, 0.1)',
            overflow: 'auto'
          }}
        >
          <div style={{ position: 'relative' }}>
            <h1 
              style={{ 
                color: 'white', 
                fontSize: '22px', 
                marginTop: '10px',
                marginBottom: '24px',
                fontWeight: '700',
                letterSpacing: '0.01em'
              }}
            >
              Bojayá Explorer
            </h1>
            
            <button
              onClick={() => setShowLeftPanel(false)}
              style={{
                position: 'absolute',
                top: '8px',
                right: '0',
                background: 'transparent',
                border: 'none',
                color: '#9CA3AF',
                cursor: 'pointer',
                padding: '8px',
                transition: 'color 150ms ease',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
            >
              <ChevronLeft size={20} />
            </button>
          </div>
          
          {/* Map selector */}
          <div style={{ marginBottom: '20px' }}>
            <h2 style={{ 
              fontSize: '16px', 
              marginBottom: '16px',
              fontWeight: '600',
              color: '#E5E7EB'
            }}>
              Seleccionar mapa
            </h2>
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '12px'
            }}>
              {maps.map((map, index) => (
                <button
                  key={map.id}
                  onClick={() => setCurrentMapIndex(index)}
                  style={{
                    background: currentMapIndex === index 
                      ? 'rgba(55, 65, 81, 0.8)' 
                      : 'rgba(31, 41, 55, 0.5)',
                    border: currentMapIndex === index 
                      ? `1px solid ${theme.colors.accent}33`
                      : '1px solid rgba(255, 255, 255, 0.05)',
                    borderLeft: currentMapIndex === index
                      ? `4px solid ${theme.colors.accent}`
                      : '1px solid rgba(255, 255, 255, 0.05)',
                    borderRadius: '8px',
                    padding: '16px',
                    textAlign: 'left',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    transition: 'all 150ms ease'
                  }}
                >
                  <span style={{ 
                    color: 'white', 
                    fontWeight: currentMapIndex === index ? '600' : '500',
                    fontSize: '14px'
                  }}>
                    {map.name}
                  </span>
                  {currentMapIndex === index && (
                    <div 
                      style={{ 
                        width: '6px', 
                        height: '6px', 
                        borderRadius: '50%', 
                        background: theme.colors.accent
                      }}
                    />
                  )}
                </button>
              ))}
            </div>
          </div>
          
          {/* Categories */}
          <div>
            <h2 style={{ 
              fontSize: '16px', 
              marginBottom: '16px',
              fontWeight: '600',
              color: '#E5E7EB'
            }}>
              Categorías
            </h2>
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '12px'
            }}>
              {categories.map(category => (
                <button
                  key={category.id}
                  onClick={() => selectCategory(category.id)}
                  style={{
                    background: activeCategory === category.id 
                      ? 'rgba(55, 65, 81, 0.8)' 
                      : 'rgba(31, 41, 55, 0.5)',
                    border: activeCategory === category.id 
                      ? `1px solid ${category.color}33`
                      : '1px solid rgba(255, 255, 255, 0.05)',
                    borderLeft: activeCategory === category.id
                      ? `4px solid ${category.color}`
                      : '1px solid rgba(255, 255, 255, 0.05)',
                    borderRadius: '8px',
                    padding: '16px',
                    textAlign: 'left',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    transition: 'all 150ms ease'
                  }}
                >
                  <div style={{
                    width: '28px',
                    height: '28px',
                    borderRadius: '50%',
                    backgroundColor: activeCategory === category.id ? category.color : 'rgba(255, 255, 255, 0.1)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                    transition: 'all 150ms ease'
                  }}>
                    <CategoryIcon 
                      category={category.id} 
                      color={activeCategory === category.id ? 'white' : category.color} 
                      size={16} 
                    />
                  </div>
                  <div style={{ 
                    display: 'flex', 
                    flexDirection: 'column',
                    gap: '2px'
                  }}>
                    <span style={{ 
                      color: 'white', 
                      fontWeight: activeCategory === category.id ? '600' : '500',
                      fontSize: '14px'
                    }}>
                      {category.name}
                    </span>
                    {category.description && (
                      <span style={{ 
                        color: '#9CA3AF',
                        fontSize: '12px',
                        fontWeight: '400'
                      }}>
                        {category.description}
                      </span>
                    )}
                  </div>
                </button>
              ))}
            </div>
          </div>
          
          {/* Bibliography button */}
          <button
            onClick={() => setShowBibliography(!showBibliography)}
            style={{
              marginTop: 'auto',
              padding: '12px 16px',
              background: 'rgba(31, 41, 55, 0.7)',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: '8px',
              color: 'white',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              transition: 'all 150ms ease'
            }}
          >
            <Book size={16} /> 
            <span>Referencias bibliográficas</span>
          </button>
        </div>
        
        {/* Right control panel */}
        <div style={{
          position: 'absolute',
          top: '24px',
          right: '24px',
          display: 'flex',
          flexDirection: 'column',
          gap: '16px',
          zIndex: 20
        }}>
          {/* Toggle left panel button */}
          {!showLeftPanel && (
            <button 
              onClick={() => setShowLeftPanel(true)}
              style={{
                width: '48px',
                height: '48px',
                borderRadius: '50%',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                backgroundColor: 'rgba(31, 41, 55, 0.6)',
                color: 'white',
                border: 'none',
                cursor: 'pointer',
                boxShadow: theme.shadows.md,
                transition: 'all 150ms ease'
              }}
              title="Menú"
            >
              <ChevronRight size={20} />
            </button>
          )}
          
          {/* Magnifier button */}
          <button 
            onClick={() => setShowMagnifier(!showMagnifier)}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: showMagnifier ? 'rgba(31, 41, 55, 0.8)' : 'rgba(31, 41, 55, 0.6)',
              color: showMagnifier ? theme.colors.accent : 'white',
              border: showMagnifier ? `1px solid ${theme.colors.accent}33` : 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Lupa"
          >
            <SearchIcon size={20} />
          </button>
          
          {/* Map legend button */}
          <button 
            onClick={() => setShowLegend(!showLegend)}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: showLegend ? 'rgba(31, 41, 55, 0.8)' : 'rgba(31, 41, 55, 0.6)',
              color: showLegend ? theme.colors.accent : 'white',
              border: showLegend ? `1px solid ${theme.colors.accent}33` : 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Convenciones"
          >
            <Layers size={20} />
          </button>
          
          {/* Information button */}
          <button 
            onClick={() => {
              // Toggle bibliography
              setShowBibliography(!showBibliography);
            }}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: showBibliography ? 'rgba(31, 41, 55, 0.8)' : 'rgba(31, 41, 55, 0.6)',
              color: showBibliography ? theme.colors.accent : 'white',
              border: showBibliography ? `1px solid ${theme.colors.accent}33` : 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Información"
          >
            <Info size={20} />
          </button>
        </div>
        
        {/* Zoom controls */}
        <div style={{
          position: 'absolute',
          bottom: '24px',
          right: '24px',
          display: 'flex',
          flexDirection: 'column',
          gap: '16px',
          zIndex: 20
        }}>
          <button 
            onClick={handleZoomIn}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(31, 41, 55, 0.6)',
              color: 'white',
              border: 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Acercar"
          >
            <Plus size={20} />
          </button>
          
          <button 
            onClick={handleZoomOut}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(31, 41, 55, 0.6)',
              color: 'white',
              border: 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Alejar"
          >
            <Minus size={20} />
          </button>
          
          <button 
            onClick={() => zoomToPoint(40, 65, 1.5)}
            style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(31, 41, 55, 0.6)',
              color: 'white',
              border: 'none',
              cursor: 'pointer',
              boxShadow: theme.shadows.md,
              transition: 'all 150ms ease'
            }}
            title="Centrar mapa"
          >
            <Compass size={20} />
          </button>
        </div>

        {/* Panel de leyenda */}
        {showLegend && (
          <div style={{ 
            position: 'fixed', 
            top: '24px', 
            right: '96px', 
            width: '320px', 
            backgroundColor: 'rgba(17, 24, 39, 0.9)',
            backdropFilter: 'blur(10px)',
            borderRadius: '16px',
            boxShadow: theme.shadows.xl,
            zIndex: 40,
            border: '1px solid rgba(255, 255, 255, 0.1)',
            fontFamily: theme.fonts.primary
          }}>
            <div style={{ padding: '24px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ 
                  fontSize: '18px', 
                  fontWeight: '500', 
                  color: '#E5E7EB',
                  margin: 0
                }}>
                  Convenciones del Mapa
                </h3>
                <button 
                  onClick={() => setShowLegend(false)}
                  style={{
                    background: 'transparent',
                    border: 'none',
                    padding: '8px',
                    borderRadius: '50%',
                    cursor: 'pointer',
                    color: '#9CA3AF',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  <X size={16} />
                </button>
              </div>
              <div style={{ 
                maxHeight: '400px', 
                overflowY: 'auto', 
                paddingRight: '8px' 
              }}>
                {categories.filter(cat => cat.id !== 'all').map(category => (
                  <div 
                    key={category.id} 
                    style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '16px', 
                      color: '#D1D5DB', 
                      padding: '10px 0',
                      borderBottom: '1px solid #374151'
                    }}
                  >
                    <div style={{
                      width: '28px',
                      height: '28px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <CategoryIcon 
                        category={category.id} 
                        color={category.color || theme.colors.accent} 
                        size={18} 
                      />
                    </div>
                    <div style={{ 
                      display: 'flex', 
                      flexDirection: 'column',
                      gap: '2px'
                    }}>
                      <span style={{ 
                        fontSize: '14px',
                        fontWeight: '500',
                        color: 'white'
                      }}>{category.name}</span>
                      <span style={{ 
                        fontSize: '12px',
                        color: '#9CA3AF'
                      }}>{category.description}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Loading overlay */}
        {isLoading && (
          <div style={{
            position: 'fixed',
            inset: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            backdropFilter: 'blur(8px)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 100,
            opacity: 1,
            transition: 'opacity 300ms ease'
          }}>
            <div style={{ textAlign: 'center' }}>
              <div style={{
                width: '64px',
                height: '64px',
                borderRadius: '50%',
                border: '4px solid transparent',
                borderTopColor: theme.colors.accent,
                animation: 'spin 1s linear infinite',
                boxShadow: theme.shadows.glow,
                margin: '0 auto'
              }} />
              <p style={{
                color: 'white',
                marginTop: '24px',
                fontSize: '18px',
                fontWeight: '300',
                letterSpacing: '0.05em',
                textAlign: 'center',
                animation: 'fadeInOut 2s ease-in-out infinite',
                fontFamily: theme.fonts.secondary
              }}>
                Explorando el territorio...
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Reproductor de Audio */}
      <AudioPlayer 
        audioPlayer={audioPlayer}
        theme={theme}
        audios={audios}
        containerRef={containerRef}
      />
    </div>
  );
};

export default MapExplorer;